# CID_scoring
A set of metrics to score CID and MG complexes

-------------------------------------------------------
# Step by step execution:
```
# setup working directory
SDIR="/work/lpdi/users/eline/CID_scoring/"
WDIR="/work/lpdi/users/eline/CID/1Z9Y_FUN_p2"

cd "$WDIR"
```
Choose an existing working directory with the following structure:
WDIR

|_ input/ \n
  |_binder_refs/ # contains a reference structure pdb file for each binder, with target in chain A, binder in B and ligand in L. Might be cleaned with the clean_refs2.py script. \n
  |_target_template.cif # the ligand + enzyme original structure (?) \n
  |_ligand.params # can be added after the af3 ternary run \n
|_output/ \n

Change SDIR in the scripts with the path to this cloned github repo.


## 1- Colab Design reprediction
Run `1run_cd.sh script` with the previous working directory as a first argument. Will repredict binary structures with colabdesign and score them with pyrosetta (BindCraft style).

## 2- AF3 input prep (binary and ternary)

Run the `run_af3_input.sh` with the following positionnal arguments: working directory, target_id, target_template file path, ligand smiles (as a quoted string), ligand name

## 3- AF3 reprediction (binary and ternary)

```
sbatch "$SDIR/scripts/run_alphafold.sh" -i "$WDIR/output/af3binary/json/" -o "$WDIR/output/af3binary/" --no-msa --num_recycles 3

sbatch "$SDIR/scripts/run_alphafold.sh" -i "$WDIR/output/af3ternary/json/" -o "$WDIR/output/af3ternary/" --no-msa --num_recycles 3
```

Before going to the next step, create a ligand params file for pyrosetta in the input folder. Ensure that the ligand's atoms numbering is the same in your file and in the structures generated by alphafold3. See e.g. how to generate a ligand from pdb here https://github.com/eline-dn/Protein_design_utils/blob/main/pyRosetta/doc.md#ligands-with-pyrosetta


## 4 - AF3 output scoring

Also change the condapath in this script. 
Run the `run_af3_output.sh` with the following positional arguments: working directory, path to the param file, ligand name (quoted as a string)

## 5 -  Metrics collection 
```
python "$SDIR/scripts/get_csv.py" --base_folder "$WDIR"
```

---------------------------------------------------------------------------------------------------
# to run the whole pipeline: (W.I.P.)

Change the working directory and conda path in the script then:
```
sbatch run_scoring1.sh
```
then create a ligand params file for pyrosetta in the input folder and run :
```
# pyrosetta scoring
CONDAPATH="/work/lpdi/users/eline/miniconda3"
"$CONDAPATH/envs/rosetta_scoring/bin/python" "$SDIR/scripts/pyrosetta_module.py" --pdb ./output/af3ternary/*/*_model.pdb --params "$WDIR/input/FUN.params" --lig_name FUN --outdir ./output/af3ternary --prefix af3_ter_pyr

```
ensure that the ligand's atoms numbering is the same in your file and in the structures generated by alphafold3. See e.g. how to generate a ligand from pdb here [https://github.com/eline-dn/Protein_design_utils/blob/main/pyRosetta/doc.md#ligands-with-pyrosetta]

---------------------------------------------------------------------------
# Usage of each module separately:

TO DO: check consistency between documentation and scripts


## Reprediction of binary complex with Colab Design:
```
python ./scripts/Colab_Design_module.py \
--ref_pdb structure1_binary_complex.pdb structure2_binary_complex.pdb \
--outdir . \
--prefix prefix
```

ref_pdb: List of ref PDBs, used to extract sequences, target template, and as references for RMSDs. Ensure the chain id's are correct.

outdir (optional, default is WD) : output folder for csv file and repredictions

prefix (optional, default is WD) : prefix for csv file

## Running AF3 on binary or ternary complexes:
1- Prepare the input json file
```
 python ./scripts/AF3_input_module.py --structure af3_ter_out.pdb --target_id 1Z9Y --target_template /work/lpdi/users/eline/CID_scoring/af3/input/1Z9Y_clean.cif --smiles "c1cc(oc1)CNc2cc(c(cc2C(=O)O)S(=O)(=O)N)Cl" --lig_name FUN --outdir af3/input
```
pdb: List of Input PDBs, used to extract sequences

target_template: target template to input to af3, must be in a CIF format with a release date before the train/test cutoff of AF3. Give an absolute path

smiles: **(for ternary complexes only)** smiles used for ligand parametrization, eg c1cc(oc1)CNc2cc(c(cc2C(=O)O)S(=O)(=O)N)Cl for the FUN ligand

lig_name: **(for ternary complexes only)** name used for ligand parametrization, eg  FUN ligand

outdir: output folder for json inputs, optional

tips for the target template file: beware of DOS file format, not parsed by AF3. check eol with `file 1Z9Y_clean.cif` and remove CRLF line terminators with `sed -i 's/\r$//' 1Z9Y_clean.cif`
if your template doesn't have a release date, add
```
#
loop_
_pdbx_audit_revision_history.ordinal 
_pdbx_audit_revision_history.data_content_type 
_pdbx_audit_revision_history.major_revision 
_pdbx_audit_revision_history.minor_revision 
_pdbx_audit_revision_history.revision_date 
1 'Structure model' 1 0 2006-05-23 
2 'Structure model' 1 1 2008-04-30 
3 'Structure model' 1 2 2011-07-13 
4 'Structure model' 1 3 2017-10-11 
# 
in the cif file's header
```


2- run AF3
```
sbatch ./scripts/run_alphafold.sh -i input_folder -o output_folder --no-msa --recycles 5
```
input_folder: with json files


3- Analyze the output structure (RMSD, confidences)
```
python ./scripts/AF3_output_module.py --ref_pdb af3_ter_out.pdb --AF3_outs /work/lpdi/users/eline/CID_scoring/af3_out/* --lig_name FUN --outdir /work/lpdi/users/eline/CID_scoring/af3_out --prefix pre
```
ref_pdb: List of ref PDBs, used to extract sequences, as target template, and as references for RMSDs. Ensure the id is the same as the folder with repredicted strucures and confidences. Also ensure the chain id's are matching.

AF3_outs: List of AF3 output folders. Ensure the id is the same as the ref_pdb.

lig_name: name used for ligand parametrization, eg  FUN ligand

outdir: output folder for csv file"

prefix: prefix for csv file


## PyRosetta Scoring (inspired from BindCraft)
```
python ./scripts/pyrosetta_module.py --pdb /work/lpdi/users/eline/smol_binder_diffusion_
pipeline/1Z9Yout/4_af3/output/t2_1_100_3_t0.1_ltp0.3_dcut8.0/t2_1_100_3_t0.1_ltp0.3_dcut8.0_model.cif --mk_params --smiles "c1cc(oc1)
CNc2cc(c(cc2C(=O)O)S(=O)(=O)N)Cl" --lig_name FUN --outdir . --prefix pre
```
pdb: List of Input PDBs

mk_params: need to create a Params files in the pdb files'dir? Set to true if the pdbs are ternary complexes. in that case, add a smiles for the ligand

smiles: **(for ternary complexes only)** smiles used for ligand parametrization, eg c1cc(oc1)CNc2cc(c(cc2C(=O)O)S(=O)(=O)N)Cl for the FUN ligand

lig_name: **(for ternary complexes only)** name used for ligand parametrization, eg  FUN ligand

outdir: output folder for csv file"

prefix: prefix for csv file

NB: run with different csv paths/prefix for binary vs ternary complex bc of column name mismatch!


## Compute DockQ (https://github.com/DigBioLab/de_novo_binder_scoring/tree/main)
```
python ./scripts/dockQ.py --input-pdbs ./refpdbs/ --folder af3:./af3_out/n9_l106_s297124_mpnn1_model1_model0/ --out-csv ./dockQ.csv --verbose
```

input-pdbs: Path to REQUIRED reference/input PDBs (binder_id.pdb).

folder: Repeatable. Format "name:path". Example: --folder af3:/path/to/AF3/pdbs

Test 2:
```
python ./scripts/pDockQ.py --native-pdbs ./refpdbs/* --model-pdbs ./af3_out/n9_l106_s297124_mpnn1_model1_model0/* --out-csv ./pdockQ2.csv
```

with a ternary complex:
```
python ./scripts/pDockQ.py --native-pdbs ./af3_ter_out.pdb --model-pdbs ./af3_out/af3_ter_out/af3_ter_out_model.pdb --out-csv ./pdockQ2ter.csv --ternary
```
see https://github.com/wallnerlab/DockQ/issues/33 and https://github.com/wallnerlab/DockQ/blob/master/src/DockQ/DockQ.py



## Compute ipSAE and interface confidence metrics (https://github.com/DigBioLab/de_novo_binder_scoring/tree/main)
```
python ./scripts/run_ipsae_batch.py --id_list af3_ter_out --out-csv ./ipsae_and_ipae3.csv --af3-dir ./af3_out/af3_ter_out/ --ipsae-script-path ./functions/ipsae_w_ipae.py --specific-chainpair-ipsae "A:B,B:A"  --pae-cutoff 10 --overwrite-ipsae --dist-cutoff 12 
```


There is a possibility to extract specific chain pair ipSAE values: use the argument
```
--specific-chainpair-ipsae "A:D,A:B,A:C" which takes a string formated like the above.
```
It is also possible to specify several thressholds for the AF3 contact prob metrics ``` --confidence-threshold "0.5,0.6,0.7,0.8,0.9" \ ```


## PLIP 

```
plip -f *.pdb -x 

```
add --intra A for interchain interactions
